---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "doc/figures/README-",
  out.width = "100%"
)
```

# cvasi: Calibration, Validation, and Simulation of TKTD models in R

<!-- badges: start -->
<!--[![CRAN status](https://www.r-pkg.org/badges/version/cvasi)](https://cran.r-project.org/package=cvasi)-->
[![R-CMD-check](https://github.com/Bayer-Group/cvasi/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/Bayer-Group/cvasi/actions/workflows/R-CMD-check.yaml)
<!--[![Codecov test coverage](https://codecov.io/gh/xy/cvasi/branch/main/graph/badge.svg)](https://app.codecov.io/gh/xy/cvasi?branch=main)-->
<!-- badges: end -->

The `cvasi` package aims to ease the use of ecotox effect models by providing an
intuitive workflow. Model inputs and parameters are encapsulated in `EffectScenario`
objects which can be piped to other functions. Operations can be chained using
the `tidyr` syntax. The most time-consuming processes can be run in parallel if
requested.

The package provides facilities to

* simulate effect models such as *GUTS-RED*, *DEB*, *Lemna*, *Myriophyllum*, and *Algae*
* calculate effect endpoints
* derive effect profiles (*EPx* values)
* import exposure time-series from *FOCUS TOXSWA*
* import fitted parameters from *morse*
* and more

Please have a look at the [CHANGELOG](CHANGELOG.md)
for an overview of user-facing updates and changes.


## Documentation

The package contains the following vignettes

* [User Manual](doc/manual.md)
* [Modeling Howto](doc/howto.md)

They can also be accessed locally by executing an *R* statement such as:
```{r, eval=FALSE}
vignette("manual", package="cvasi")
```


## Installation

<!-- 1. Install from CRAN -->
<!-- ```{r eval=FALSE} -->
<!-- install.packages("cvasi", dependencies=TRUE) -->
<!-- ``` -->

Install latest version from GitHub:

```{r eval=FALSE}
install.packages("remotes", dependencies=TRUE)
remotes::install_github("Bayer-Group/cvasi", dependencies=TRUE, upgrade="never")
```

## Example

Basic usage:
```{r,message=FALSE}
library(cvasi)

# create and parameterize a GUTS-RED-IT scenario
GUTS_RED_IT() %>%
  set_param(c(kd=0.0005,hb=0,alpha=0.4,beta=1.5)) %>%
  set_exposure(data.frame(t=c(0,100,101,200,201,400),pec=c(0,0,0.1,0.1,0,0))) -> scenario

# simulate scenario
scenario %>%
  simulate(times=1:400) %>%
  tail()
```

Calculation of effects:
```{r drc,out.width="50%",warning=FALSE}
# calculate effect level
scenario %>% effect()

# create a dose response curve
scenario %>% dose_response() -> drc
head(drc)

library(ggplot2)
ggplot(drc) + geom_point(aes(mf,effect)) + scale_x_log10()
# derive EPx values
scenario %>% epx()
```

Multiple scenarios can be processed in parallel without modifications to the workflow:
```{r eval=FALSE}
future::plan(future::multisession)

c(GUTS_RED_IT(),GUTS_RED_SD()) %>%
  set_param(morse("path/to/fitted.RData")) %>%
  epx()
```
